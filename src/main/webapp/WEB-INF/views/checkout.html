<!DOCTYPE html>
<html th:lang="${#locale.language}" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title th:text="#{checkout.title}">結帳</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
        <a class="navbar-brand" th:href="@{/}">YingShop</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" th:attr="aria-label=#{nav.toggle.menu}">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" th:href="@{/}" th:text="#{nav.home}">首頁</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/products}" th:text="#{nav.products}">商品列表</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/cart}" th:text="#{nav.cart}">購物車</a></li>
                <li class="nav-item" sec:authorize="isAnonymous()"><a class="nav-link" th:href="@{'/#authSection'}" th:text="#{nav.orders}">我的訂單</a></li>
                <li class="nav-item" sec:authorize="isAuthenticated() and !hasRole('ADMIN') and !hasRole('STAFF')"><a class="nav-link" th:href="@{/orders/mine}" th:text="#{nav.orders}">我的訂單</a></li>
                <li class="nav-item" sec:authorize="isAuthenticated() and !hasRole('ADMIN') and !hasRole('STAFF')"><a class="nav-link" th:href="@{/account/profile}" th:text="#{nav.profile}">個人資料</a></li>
                <li class="nav-item" sec:authorize="hasRole('ADMIN')"><a class="nav-link" th:href="@{/admin}" th:text="#{nav.admin}">後台管理</a></li>
            </ul>
            <div class="d-flex align-items-center gap-2 ms-auto">
                <div class="me-2">
                    <a class="text-white text-decoration-none lang-switch" href="#" data-lang="en">English</a>
                    <span class="text-white mx-1">|</span>
                    <a class="text-white text-decoration-none lang-switch" href="#" data-lang="zh_TW">繁體中文</a>
                </div>
                <div class="d-flex align-items-center gap-2" sec:authorize="isAuthenticated() and !hasRole('ADMIN') and !hasRole('STAFF')">
                    <form th:action="@{/logout}" method="post" class="m-0">
                        <button class="btn btn-outline-light" type="submit" th:text="#{nav.logout}">登出</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</nav>

<main class="container py-4">
    <div th:if="${successMessage}" class="alert alert-success" th:text="${successMessage}"></div>
    <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0" th:text="#{checkout.title}">結帳</h1>
        <a class="btn btn-outline-secondary" th:href="@{/cart}" th:text="#{common.back}">返回購物車</a>
    </div>

    <div class="row g-4">
        <!-- 購買清單 -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h2 class="h5 mb-0" th:text="#{checkout.order.items}">購買清單</h2>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped mb-0">
                            <thead class="table-light">
                            <tr>
                                <th style="width: 100px;" th:text="${#locale.language == 'zh' ? '圖片' : 'Image'}">圖片</th>
                                <th th:text="#{cart.item.name}">商品名稱</th>
                                <th class="text-center" th:text="#{cart.quantity}">數量</th>
                                <th class="text-end" th:text="#{cart.unit.price}">單價</th>
                                <th class="text-end" th:text="#{cart.subtotal}">小計</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="itemDetail : ${selectedItems}">
                                <td>
                                    <img th:if="${itemDetail.product.imageUrl != null && !#strings.isEmpty(itemDetail.product.imageUrl)}"
                                         th:src="${itemDetail.product.imageUrl}"
                                         th:alt="${itemDetail.product.name}"
                                         class="img-thumbnail"
                                         style="width: 80px; height: 80px; object-fit: cover;">
                                    <span th:if="${itemDetail.product.imageUrl == null || #strings.isEmpty(itemDetail.product.imageUrl)}"
                                          class="text-muted small" th:text="#{products.no.image}">無圖片</span>
                                </td>
                                <td th:text="${itemDetail.cartItem.name}">商品名稱</td>
                                <td class="text-center" th:text="${itemDetail.cartItem.quantity}">1</td>
                                <td class="text-end">
                                    <span th:text="${#locale.language == 'zh' ? 'NTD ' : 'USD '}"></span>
                                    <span th:text="${#numbers.formatDecimal(itemDetail.cartItem.unitPrice, 1, 'COMMA', 2, 'POINT')}">$0.00</span>
                                </td>
                                <td class="text-end">
                                    <span th:text="${#locale.language == 'zh' ? 'NTD ' : 'USD '}"></span>
                                    <span th:text="${#numbers.formatDecimal(itemDetail.cartItem.subtotal, 1, 'COMMA', 2, 'POINT')}">$0.00</span>
                                </td>
                            </tr>
                            </tbody>
                            <tfoot class="table-light">
                            <tr>
                                <td colspan="4" class="text-end fw-bold" th:text="#{cart.total.amount}">總金額</td>
                                <td class="text-end fw-bold text-primary">
                                    <span th:text="${#locale.language == 'zh' ? 'NTD ' : 'USD '}"></span>
                                    <span th:text="${#numbers.formatDecimal(selectedTotalPrice, 1, 'COMMA', 2, 'POINT')}">$0.00</span>
                                </td>
                            </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- 結帳表單 -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h2 class="h5 mb-0" th:text="#{checkout.order.info}">訂單資訊</h2>
                </div>
                <div class="card-body">
                    <form th:action="@{/checkout}" method="post" class="row g-3">
                        <input type="hidden" name="userId" th:value="${user.id}"/>

                        <!-- 收件資料 -->
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3" th:text="#{checkout.recipient.info}">收件資料</h5>
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="recipientName" th:text="#{checkout.recipient.name}">收件人姓名 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="recipientName" name="recipientName" required
                                   th:value="${user.name}">
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="recipientPhone" th:text="#{checkout.recipient.phone}">收件人電話 <span class="text-danger">*</span></label>
                            <input type="tel" class="form-control" id="recipientPhone" name="recipientPhone" required>
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="recipientEmail" th:text="#{checkout.recipient.email}">收件人信箱 <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="recipientEmail" name="recipientEmail" required
                                   th:value="${user.email}">
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="recipientAddress" th:text="#{checkout.recipient.address}">收件地址 <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="recipientAddress" name="recipientAddress" rows="3" required></textarea>
                        </div>

                        <!-- 配送付款方式 -->
                        <div class="col-12">
                            <h5 class="border-bottom pb-2 mb-3" th:text="#{checkout.delivery.payment.method}">配送付款方式</h5>
                        </div>
                        <div class="col-12">
                            <div th:each="method : ${deliveryPaymentMethods}" class="form-check">
                                <input class="form-check-input delivery-payment-method-radio" type="radio" name="deliveryPaymentMethod"
                                       th:id="${'dpm-' + method.name()}"
                                       th:value="${method.name()}"
                                       th:checked="${method.name() == 'CASH_ON_DELIVERY'}"
                                       required>
                                <label class="form-check-label" th:for="${'dpm-' + method.name()}"
                                       th:with="methodKey=${'delivery.payment.' + #strings.toLowerCase(#strings.replace(method.name(), '_', '.'))}"
                                       th:text="#{__${methodKey}__}"></label>
                            </div>
                        </div>

                        <div class="col-12">
                            <button type="submit" class="btn btn-success w-100" id="submitBtn" th:text="#{checkout.submit}">確認下單</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        // 語言切換處理
        document.querySelectorAll('.lang-switch').forEach(function (link) {
            link.addEventListener('click', function (event) {
                event.preventDefault();
                var lang = this.getAttribute('data-lang');
                var url = new URL(window.location.href);
                url.searchParams.set('lang', lang);
                window.location.href = url.toString();
            });
        });

        // 配送付款方式和地址聯動
        var deliveryPaymentRadios = document.querySelectorAll('.delivery-payment-method-radio');
        var addressTextarea = document.getElementById('recipientAddress');
        var pickupText = /*[[#{delivery.pickup}]]*/ '自取';

        function updateAddress() {
            var selectedMethod = document.querySelector('input[name="deliveryPaymentMethod"]:checked');
            if (!selectedMethod) return;

            var method = selectedMethod.value;
            
            // 根據配送付款方式設置地址
            if (method === 'CASH_ON_DELIVERY') {
                // 貨到付款 -> 地址可編輯，必填
                // 如果當前地址是"自取"，則清空
                if (addressTextarea.value === pickupText || addressTextarea.value.trim() === '自取') {
                    addressTextarea.value = '';
                }
                addressTextarea.readOnly = false;
                addressTextarea.required = true;
            } else if (method === 'PICKUP_CASH') {
                // 自取付現 -> 地址自動填寫"自取"，只讀
                addressTextarea.value = pickupText;
                addressTextarea.readOnly = true;
                addressTextarea.required = false;
            }
        }

        // 監聽配送付款方式變化
        deliveryPaymentRadios.forEach(function(radio) {
            radio.addEventListener('change', updateAddress);
        });

        // 初始化
        updateAddress();
    });
</script>
</body>
</html>

